@using Proyecto.ViewModels
@using Proyecto.Models

<div class="modal-overlay @(IsVisible ? "visible" : "")">
    <div class="modal-content">
        <div class="modal-header">
            <h2>@(ViewModel.IsEditMode ? "Editar Proyecto" : "Crear Nuevo Proyecto")</h2>
            <button class="close-btn" @onclick="Close">×</button>
        </div>

        <div class="modal-body">
            <!-- Campo Nombre -->
            <div class="form-group">
                <label for="projectName">Nombre del Proyecto</label>
                <input id="projectName" 
                       type="text" 
                       @bind="ViewModel.CurrentProject.Name" 
                       @bind:event="oninput"
                       placeholder="Ingresa un nombre para tu proyecto" />
            </div>

            <!-- Campo Imagen (solo para crear) -->
            @if (!ViewModel.IsEditMode)
            {
                <div class="form-group">
                    <label for="imageUpload">Imagen</label>
                    <InputFile id="imageUpload" 
                               accept="image/*" 
                               OnChange="HandleImageUpload" 
                               class="file-input" />
                    
                    @if (!string.IsNullOrEmpty(ViewModel.ImagePreview))
                    {
                        <div class="image-preview">
                            <img src="@ViewModel.ImagePreview" alt="Vista previa" />
                        </div>
                    }
                </div>
            }
            else
            {
                <!-- En modo editar, mostrar imagen existente -->
                <div class="form-group">
                    <label>Imagen Actual</label>
                    <div class="image-preview">
                        <img src="@ViewModel.ImagePreview" alt="Imagen actual" />
                    </div>
                </div>
            }
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" @onclick="Close">Cancelar</button>
            <button class="btn btn-primary" 
                    @onclick="Confirm" 
                    disabled="@(!ViewModel.IsValid())">
                @(ViewModel.IsEditMode ? "Actualizar" : "Crear")
            </button>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public ProjectDialogViewModel ViewModel { get; set; }

    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    [Parameter]
    public EventCallback<Project> OnConfirm { get; set; }

    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            // Convertir imagen a DataURL
            var buffer = new byte[file.Size];
            await file.OpenReadStream().ReadAsync(buffer);
            var base64String = Convert.ToBase64String(buffer);
            var dataUrl = $"data:{file.ContentType};base64,{base64String}";
            
            ViewModel.SetImage(dataUrl);
        }
    }

    private async Task Confirm()
    {
        await OnConfirm.InvokeAsync(ViewModel.CurrentProject);
    }

    private async Task Close()
    {
        await OnClose.InvokeAsync();
    }
}
@using Proyecto.ViewModels
@using Proyecto.Models

<div class="modal-overlay @(IsVisible ? "visible" : "")">
    <div class="modal-content">
        <div class="modal-header">
            <h2>@(ViewModel.IsEditMode ? "Editar Proyecto" : "Crear Nuevo Proyecto")</h2>
            <button class="close-btn" @onclick="Close">×</button>
        </div>

        <div class="modal-body">
            <!-- Campo Nombre -->
            <div class="form-group">
                <label for="projectName">Nombre del Proyecto</label>
                <input id="projectName"
                       type="text"
                       @bind="ViewModel.CurrentProject.Name"
                       @bind:event="oninput"
                       placeholder="Ingresa un nombre para tu proyecto" />
            </div>

            <!-- Campo Imagen (solo para crear) -->
            @if (!ViewModel.IsEditMode)
            {
                <div class="form-group">
                    <label for="imageUpload">Imagen</label>
                    <InputFile id="imageUpload"
                               accept="image/*"
                               OnChange="HandleImageUpload"
                               class="file-input" />

                    @if (!string.IsNullOrEmpty(ViewModel.ImagePreview))
                    {
                        <div class="image-preview">
                            <img src="@ViewModel.ImagePreview" alt="Vista previa" />
                        </div>
                    }
                </div>
            }
            else
            {
                <!-- En modo editar, mostrar imagen existente -->
                <div class="form-group">
                    <label>Imagen Actual</label>
                    <div class="image-preview">
                        <img src="@ViewModel.ImagePreview" alt="Imagen actual" />
                    </div>
                </div>
            }
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" @onclick="Close">Cancelar</button>
            <button class="btn btn-primary"
                    @onclick="Confirm"
                    disabled="@(!ViewModel.IsValid())">
                @(ViewModel.IsEditMode ? "Actualizar" : "Crear")
            </button>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public ProjectDialogViewModel ViewModel { get; set; }

    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    [Parameter]
    public EventCallback<Project> OnConfirm { get; set; }

    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            var buffer = new byte[file.Size];
            await file.OpenReadStream().ReadAsync(buffer);
            var base64String = Convert.ToBase64String(buffer);
            var dataUrl = $"data:{file.ContentType};base64,{base64String}";

            ViewModel.SetImage(dataUrl);
        }
    }

    private async Task Confirm()
    {
        await OnConfirm.InvokeAsync(ViewModel.CurrentProject);
    }

    private async Task Close()
    {
        await OnClose.InvokeAsync();
    }
}