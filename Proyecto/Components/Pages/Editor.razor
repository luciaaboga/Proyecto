@page "/editor/{ProjectId}"
@using Proyecto.Models
@using Proyecto.Contracts
@using Proyecto.ViewModels
@using Proyecto.Services
@inject NavigationManager Navigation
@inject IEditorService EditorService
@inject IProjectService ProjectService
@inject IJSRuntime JSRuntime

<div class="editor-layout">
    <div class="editor-header">
        <div class="header-left">
            <button class="btn btn-outline" @onclick="VolverAProyectos">
                <i class="bi bi-arrow-left"></i> Volver
            </button>
        </div>

        <div class="header-center">
            <h1 class="project-title">@(viewModel.CurrentProject?.Name ?? "Editor")</h1>
        </div>

        <div class="header-right">
            <button class="btn btn-warning btn-sm" @onclick="ResetearFiltros">
                <i class="bi bi-arrow-clockwise"></i> Resetear
            </button>
            <button class="btn btn-success btn-sm" @onclick="GuardarProyecto">
                <i class="bi bi-floppy"></i> Guardar
            </button>
            <button class="btn btn-whatsapp btn-sm" @onclick="ConvertirAStickerWhatsApp">
                <i class="bi bi-whatsapp"></i> Sticker
            </button>
            <button class="btn btn-primary btn-sm" @onclick="DescargarImagen">
                <i class="bi bi-download"></i> Descargar
            </button>
        </div>
    </div>

    <div class="editor-content">
        <aside class="controls-panel">
            <nav class="controls-nav">
                <button class="nav-btn @(viewModel.ActiveTab == "filters" ? "active" : "")"
                        @onclick='() => viewModel.SetActiveTab("filters")'>
                    <i class="bi bi-sliders"></i>
                    <span>Filtros</span>
                </button>
                <button class="nav-btn @(viewModel.ActiveTab == "adjust" ? "active" : "")"
                        @onclick='() => viewModel.SetActiveTab("adjust")'>
                    <i class="bi bi-tools"></i>
                    <span>Ajustes</span>
                </button>
                <button class="nav-btn @(viewModel.ActiveTab == "transform" ? "active" : "")"
                        @onclick='() => viewModel.SetActiveTab("transform")'>
                    <i class="bi bi-arrow-repeat"></i>
                    <span>Transformar</span>
                </button>
                <button class="nav-btn @(viewModel.ActiveTab == "stickers" ? "active" : "")"
                        @onclick='() => viewModel.SetActiveTab("stickers")'>
                    <i class="bi bi-stars"></i>
                    <span>Stickers</span>
                </button>
                <button class="nav-btn @(viewModel.ActiveTab == "text" ? "active" : "")"
                        @onclick='() => viewModel.SetActiveTab("text")'>
                    <i class="bi bi-fonts"></i>
                    <span>Texto</span>
                </button>
            </nav>
        </aside>

        <div class="content-panel @(viewModel.ActiveTab != "" ? "expanded" : "")">
            <div class="panel-content">
                @if (viewModel.ActiveTab == "filters")
                {
                    <div class="tab-content">
                        <h4>Filtros R√°pidos</h4>
                        <div class="filters-grid scrollable-content">
                            <button class="filter-preset" @onclick='() => AplicarFiltroPredeterminado("normal")'>
                                <div class="filter-preview normal"></div>
                                <span>Normal</span>
                            </button>
                            <button class="filter-preset" @onclick='() => AplicarFiltroPredeterminado("vintage")'>
                                <div class="filter-preview vintage"></div>
                                <span>Vintage</span>
                            </button>
                            <button class="filter-preset" @onclick='() => AplicarFiltroPredeterminado("bw")'>
                                <div class="filter-preview bw"></div>
                                <span>Blanco/Negro</span>
                            </button>
                            <button class="filter-preset" @onclick='() => AplicarFiltroPredeterminado("warm")'>
                                <div class="filter-preview warm"></div>
                                <span>C√°lido</span>
                            </button>
                            <button class="filter-preset" @onclick='() => AplicarFiltroPredeterminado("cool")'>
                                <div class="filter-preview cool"></div>
                                <span>Fr√≠o</span>
                            </button>
                            <button class="filter-preset" @onclick='() => AplicarFiltroPredeterminado("blue")'>
                                <div class="filter-preview blue"></div>
                                <span>Azul</span>
                            </button>
                            <button class="filter-preset" @onclick='() => AplicarFiltroPredeterminado("red")'>
                                <div class="filter-preview red"></div>
                                <span>Rojo</span>
                            </button>
                        </div>
                    </div>
                }

                @if (viewModel.ActiveTab == "adjust")
                {
                    <div class="tab-content">
                        <h4>Ajustes B√°sicos</h4>
                        <div class="controls-scrollable">
                            <div class="control-item">
                                <label>
                                    <i class="bi bi-brightness-high"></i>
                                    Brillo
                                    <span class="value">@viewModel.EditorState.Brightness%</span>
                                </label>
                                <input type="range" min="0" max="200"
                                       @bind="viewModel.EditorState.Brightness"
                                       @bind:event="oninput"
                                       @onchange="AplicarFiltros"
                                       class="control-slider" />
                            </div>

                            <div class="control-item">
                                <label>
                                    <i class="bi bi-contrast"></i>
                                    Contraste
                                    <span class="value">@viewModel.EditorState.Contrast%</span>
                                </label>
                                <input type="range" min="0" max="200"
                                       @bind="viewModel.EditorState.Contrast"
                                       @bind:event="oninput"
                                       @onchange="AplicarFiltros"
                                       class="control-slider" />
                            </div>

                            <div class="control-item">
                                <label>
                                    <i class="bi bi-droplet"></i>
                                    Saturaci√≥n
                                    <span class="value">@viewModel.EditorState.Saturation%</span>
                                </label>
                                <input type="range" min="0" max="200"
                                       @bind="viewModel.EditorState.Saturation"
                                       @bind:event="oninput"
                                       @onchange="AplicarFiltros"
                                       class="control-slider" />
                            </div>
                        </div>
                    </div>
                }

                @if (viewModel.ActiveTab == "transform")
                {
                    <div class="tab-content">
                        <h4>Transformaciones</h4>
                        <div class="controls-scrollable">
                            <div class="control-group">
                                <label>
                                    <i class="bi bi-crop"></i>
                                    Recortar Imagen
                                </label>
                                <div class="crop-controls scrollable-section">
                                    <button class="btn btn-sm @(viewModel.EditorState.IsCropping ? "btn-primary" : "btn-outline")"
                                            @onclick="ToggleCropping">
                                        @(viewModel.EditorState.IsCropping ? "Desactivar Recorte" : "Activar Recorte")
                                    </button>

                                    @if (viewModel.EditorState.IsCropping)
                                    {
                                        <div class="crop-controls">
                                            <button class="btn btn-sm btn-success"
                                                    @onclick:preventDefault
                                                    @onclick:stopPropagation
                                                    @onclick="AplicarRecorte">
                                                <i class="bi bi-check"></i>
                                                Aplicar Recorte
                                            </button>
                                            <button class="btn btn-sm btn-secondary"
                                                    @onclick:preventDefault
                                                    @onclick:stopPropagation
                                                    @onclick="CancelarRecorte">
                                                <i class="bi bi-x"></i>
                                                Cancelar
                                            </button>

                                            <div class="crop-dimensions scrollable-subsection">
                                                <div class="dimension-input">
                                                    <label>X:</label>
                                                    <input type="number" @bind="viewModel.EditorState.CropArea.X"
                                                           @bind:event="oninput"
                                                           @onclick:preventDefault
                                                           @onclick:stopPropagation
                                                           class="form-control-sm" />
                                                </div>
                                                <div class="dimension-input">
                                                    <label>Y:</label>
                                                    <input type="number" @bind="viewModel.EditorState.CropArea.Y"
                                                           @bind:event="oninput"
                                                           @onclick:preventDefault
                                                           @onclick:stopPropagation
                                                           class="form-control-sm" />
                                                </div>
                                                <div class="dimension-input">
                                                    <label>Ancho:</label>
                                                    <input type="number" @bind="viewModel.EditorState.CropArea.Width"
                                                           @bind:event="oninput"
                                                           @onclick:preventDefault
                                                           @onclick:stopPropagation
                                                           class="form-control-sm" />
                                                </div>
                                                <div class="dimension-input">
                                                    <label>Alto:</label>
                                                    <input type="number" @bind="viewModel.EditorState.CropArea.Height"
                                                           @bind:event="oninput"
                                                           @onclick:preventDefault
                                                           @onclick:stopPropagation
                                                           class="form-control-sm" />
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>

                            <div class="control-group">
                                <label>
                                    <i class="bi bi-aspect-ratio"></i>
                                    Distorsi√≥n de Perspectiva
                                </label>
                                <div class="perspective-controls scrollable-section">
                                    <div class="perspective-slider">
                                        <label>
                                            Perspectiva Horizontal:
                                            <span class="value">@viewModel.EditorState.Perspective%</span>
                                        </label>
                                        <input type="range" min="-100" max="100"
                                               @bind="viewModel.EditorState.Perspective"
                                               @bind:event="oninput"
                                               class="perspective-slider-control" />
                                        <div class="slider-labels">
                                            <span>-100%</span>
                                            <span>0%</span>
                                            <span>100%</span>
                                        </div>
                                    </div>

                                    <div class="perspective-slider">
                                        <label>
                                            Perspectiva Vertical:
                                            <span class="value">@viewModel.EditorState.PerspectiveVertical%</span>
                                        </label>
                                        <input type="range" min="-100" max="100"
                                               @bind="viewModel.EditorState.PerspectiveVertical"
                                               @bind:event="oninput"
                                               class="perspective-slider-control" />
                                        <div class="slider-labels">
                                            <span>-100%</span>
                                            <span>0%</span>
                                            <span>100%</span>
                                        </div>
                                    </div>

                                    <button class="btn btn-sm btn-outline" @onclick="ResetPerspective">
                                        <i class="bi bi-arrow-clockwise"></i>
                                        Resetear Perspectiva
                                    </button>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>Rotaci√≥n</label>
                                <div class="button-group">
                                    <button class="btn btn-sm btn-outline" @onclick="RotarIzquierda">
                                        <i class="bi bi-arrow-counterclockwise"></i>
                                        90¬∞
                                    </button>
                                    <button class="btn btn-sm btn-outline" @onclick="RotarDerecha">
                                        <i class="bi bi-arrow-clockwise"></i>
                                        90¬∞
                                    </button>
                                    <button class="btn btn-sm btn-outline" @onclick="Rotar180">
                                        <i class="bi bi-arrow-repeat"></i>
                                        180¬∞
                                    </button>
                                </div>
                                <div class="rotation-display">
                                    √Ångulo: @viewModel.EditorState.Rotation¬∞
                                </div>
                            </div>

                            <div class="control-group">
                                <label>Voltear</label>
                                <div class="button-group">
                                    <button class="btn btn-sm @(viewModel.EditorState.FlipHorizontal ? "btn-primary" : "btn-outline")"
                                            @onclick="ToggleFlipHorizontal">
                                        <i class="bi bi-arrow-left-right"></i>
                                        Horizontal
                                    </button>
                                    <button class="btn btn-sm @(viewModel.EditorState.FlipVertical ? "btn-primary" : "btn-outline")"
                                            @onclick="ToggleFlipVertical">
                                        <i class="bi bi-arrow-up-down"></i>
                                        Vertical
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                @if (viewModel.ActiveTab == "stickers")
                {
                    <div class="tab-content">
                        <h4>Stickers</h4>
                        <div class="stickers-grid scrollable-content">
                            <div class="sticker-category">
                                <h5>Emojis</h5>
                                <div class="stickers-list">
                                    <button class="sticker-item" @onclick='() => AgregarSticker(" üòä")'>üòä</button>
                                    <button class="sticker-item" @onclick='() => AgregarSticker(" ‚ù§Ô∏è")'>‚ù§Ô∏è</button>
                                    <button class="sticker-item" @onclick='() => AgregarSticker(" ‚≠ê")'>‚≠ê</button>
                                    <button class="sticker-item" @onclick='() => AgregarSticker(" üéâ")'>üéâ</button>
                                    <button class="sticker-item" @onclick='() => AgregarSticker(" üî•")'>üî•</button>
                                    <button class="sticker-item" @onclick='() => AgregarSticker(" üåü")'>üåü</button>
                                </div>
                            </div>

                            <div class="sticker-actions">
                                <button class="btn btn-sm btn-outline" @onclick="EliminarTodosStickers">
                                    <i class="bi bi-trash"></i> Eliminar Todos
                                </button>
                            </div>
                        </div>
                    </div>
                }

                @if (viewModel.ActiveTab == "text")
                {
                    <div class="tab-content">
                        <h4>Agregar Texto</h4>
                        <div class="text-controls scrollable-content">
                            <input type="text" class="form-control" placeholder="Escribe tu texto..."
                                   @bind="nuevoTexto" @bind:event="oninput" />

                            <div class="text-options">
                                <label>Tama√±o:</label>
                                <input type="range" min="12" max="72" @bind="tamanoTexto" @bind:event="oninput"
                                       class="text-size-slider" />
                            </div>

                            <div class="text-options">
                                <label>Color:</label>
                                <input type="color" @bind="colorTexto" class="color-picker" />
                            </div>

                            <div class="text-options">
                                <button class="btn btn-sm @(textoNegrita ? "btn-primary" : "btn-outline")"
                                        @onclick="() => textoNegrita = !textoNegrita">
                                    <i class="bi bi-type-bold"></i>
                                </button>
                                <button class="btn btn-sm @(textoItalica ? "btn-primary" : "btn-outline")"
                                        @onclick="() => textoItalica = !textoItalica">
                                    <i class="bi bi-type-italic"></i>
                                </button>
                            </div>

                            <button class="btn btn-primary btn-sm" @onclick="AgregarTexto">
                                <i class="bi bi-plus-circle"></i>
                                Agregar Texto
                            </button>

                            <div class="text-actions" style="margin-top: 1rem;">
                                <button class="btn btn-sm btn-outline" @onclick="EliminarTodosTextos">
                                    <i class="bi bi-trash"></i> Eliminar Todos los Textos
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <main class="image-area">
            <div class="image-container" @onmousemove="HandleMouseMove" @onmouseup="HandleMouseUp">
                @if (!string.IsNullOrEmpty(viewModel.CurrentProject?.ImagePath))
                {
                    <div class="image-wrapper" style="transform: scale(@zoomLevel); transform-origin: center;">
                        <img src="@viewModel.CurrentProject.ImagePath"
                             alt="@viewModel.CurrentProject.Name"
                             class="editable-image"
                             style="@GetImageStyles()" />

                        @if (viewModel.EditorState.IsCropping)
                        {
                            <div class="crop-overlay">
                                <div class="crop-area"
                                     style="left: @(viewModel.EditorState.CropArea.X)px;
                                                    top: @(viewModel.EditorState.CropArea.Y)px;
                                                    width: @(viewModel.EditorState.CropArea.Width)px;
                                                    height: @(viewModel.EditorState.CropArea.Height)px;"
                                     @onmousedown="@((e) => StartCropDragging("move", e))">

                                    <div class="crop-handle top" @onmousedown="@((e) => StartCropDragging("top", e))"></div>
                                    <div class="crop-handle bottom" @onmousedown="@((e) => StartCropDragging("bottom", e))"></div>
                                    <div class="crop-handle left" @onmousedown="@((e) => StartCropDragging("left", e))"></div>
                                    <div class="crop-handle right" @onmousedown="@((e) => StartCropDragging("right", e))"></div>
                                    <div class="crop-handle top-left" @onmousedown="@((e) => StartCropDragging("top-left", e))"></div>
                                    <div class="crop-handle top-right" @onmousedown="@((e) => StartCropDragging("top-right", e))"></div>
                                    <div class="crop-handle bottom-left" @onmousedown="@((e) => StartCropDragging("bottom-left", e))"></div>
                                    <div class="crop-handle bottom-right" @onmousedown="@((e) => StartCropDragging("bottom-right", e))"></div>
                                </div>
                            </div>
                        }

                        @foreach (var sticker in viewModel.EditorState.Stickers)
                        {
                            <div class="sticker-overlay"
                                 style="left: @(sticker.X)px; top: @(sticker.Y)px; transform: scale(@sticker.ScaleX, @sticker.ScaleY) rotate(@(sticker.Rotation)deg);"
                                 @onmousedown="@((e) => StartDragging(sticker, e))">

                                @if (sticker.Content.StartsWith("http"))
                                {
                                    <img src="@sticker.Content" class="sticker-img" />
                                }
                                else
                                {
                                    <span class="sticker-emoji">@sticker.Content</span>
                                }

                                <div class="resize-handle width-handle"
                                     @onmousedown="@((e) => StartResizingWidth(sticker, e))"></div>

                                <div class="resize-handle height-handle"
                                     @onmousedown="@((e) => StartResizingHeight(sticker, e))"></div>

                                <div class="resize-handle both-handle"
                                     @onmousedown="@((e) => StartResizingBoth(sticker, e))"></div>

                                <button class="delete-handle"
                                        @onclick="@(() => EliminarSticker(sticker))"
                                        title="Eliminar sticker">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        }

                        @foreach (var textElement in viewModel.EditorState.TextElements)
                        {
                            <div class="text-overlay"
                                 style="left: @(textElement.X)px; top: @(textElement.Y)px; transform: scale(@textElement.ScaleX, @textElement.ScaleY) rotate(@(textElement.Rotation)deg); color: @textElement.Color; font-family: @textElement.FontFamily; font-size: @(textElement.FontSize)px; font-weight: @(textElement.IsBold ? "bold" : "normal"); font-style: @(textElement.IsItalic ? "italic" : "normal");"
                                 @onmousedown="@((e) => StartDragging(textElement, e))">

                                @textElement.Text

                                <div class="resize-handle width-handle"
                                     @onmousedown="@((e) => StartResizingWidth(textElement, e))"></div>

                                <div class="resize-handle height-handle"
                                     @onmousedown="@((e) => StartResizingHeight(textElement, e))"></div>

                                <div class="resize-handle both-handle"
                                     @onmousedown="@((e) => StartResizingBoth(textElement, e))"></div>

                                <button class="delete-handle"
                                        @onclick="@(() => EliminarTexto(textElement))"
                                        title="Eliminar texto">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="no-image">
                        <i class="bi bi-image"></i>
                        <p>No hay imagen para editar</p>
                    </div>
                }
            </div>

            <div class="zoom-controls">
                <button class="btn btn-sm btn-outline" @onclick="ZoomOut" title="Alejar">
                    <i class="bi bi-dash"></i>
                </button>
                <span class="zoom-level">@((zoomLevel * 100).ToString("0"))%</span>
                <button class="btn btn-sm btn-outline" @onclick="ZoomIn" title="Acercar">
                    <i class="bi bi-plus"></i>
                </button>
                <button class="btn btn-sm btn-outline" @onclick="ResetZoom" title="Tama√±o original">
                    <i class="bi bi-fullscreen"></i>
                </button>
            </div>
        </main>
    </div>
</div>

@code {
    [Parameter]
    public string? ProjectId { get; set; }

    private EditorViewModel viewModel = null!;
    private double zoomLevel = 1.0;

    // Variables para arrastre
    private bool isDragging = false;
    private object draggedElement = null;
    private double dragStartX, dragStartY;
    private double elementStartX, elementStartY;

    // Variables para redimensionamiento
    private bool isResizing = false;
    private bool isResizingWidth = false;
    private bool isResizingHeight = false;
    private bool isResizingBoth = false;
    private object resizedElement = null;
    private double resizeStartX, resizeStartY;
    private double elementStartScale;
    private double elementStartScaleX, elementStartScaleY;

    // Variables para texto
    private string nuevoTexto = "";
    private string colorTexto = "#000000";
    private int tamanoTexto = 24;
    private bool textoNegrita = false;
    private bool textoItalica = false;

    // Variables para recorte
    private bool isCropDragging = false;
    private double cropStartX, cropStartY;
    private double cropAreaStartX, cropAreaStartY, cropAreaStartWidth, cropAreaStartHeight;

    // ========== M√âTODOS DE INICIALIZACI√ìN ==========
    protected override async Task OnInitializedAsync()
    {
        viewModel = new EditorViewModel(EditorService, ProjectService);
        await CargarProyecto();
    }

    private async Task CargarProyecto()
    {
        if (!string.IsNullOrEmpty(ProjectId) && Guid.TryParse(ProjectId, out Guid projectGuid))
        {
            await viewModel.LoadProjectAsync(projectGuid);
            StateHasChanged();
        }
    }

    // ========== M√âTODOS DE IMAGEN Y ESTILOS ==========
    private string GetImageStyles()
    {
        var styles = new List<string>();
        var transforms = new List<string>();

        styles.Add($"filter: brightness({viewModel.EditorState.Brightness}%) contrast({viewModel.EditorState.Contrast}%) saturate({viewModel.EditorState.Saturation}%)");

        transforms.Add($"rotate({viewModel.EditorState.Rotation}deg)");
        if (viewModel.EditorState.FlipHorizontal) transforms.Add("scaleX(-1)");
        if (viewModel.EditorState.FlipVertical) transforms.Add("scaleY(-1)");
        transforms.Add($"scale({zoomLevel})");

        if (viewModel.EditorState.Perspective != 0 || viewModel.EditorState.PerspectiveVertical != 0)
        {
            var perspectiveX = viewModel.EditorState.Perspective / 100.0;
            var perspectiveY = viewModel.EditorState.PerspectiveVertical / 100.0;

            var matrix = $"matrix(1, {perspectiveY * 0.2}, {perspectiveX * 0.2}, 1, 0, 0)";
            transforms.Add(matrix);
        }

        styles.Add($"transform: {string.Join(" ", transforms)}");

        return string.Join("; ", styles);
    }

    // ========== M√âTODOS DE FILTROS Y TRANSFORMACIONES ==========
    private async Task AplicarFiltros()
    {
        await viewModel.ApplyFiltersAsync();
        StateHasChanged();
    }

    private async Task ResetearFiltros()
    {
        await viewModel.ResetFiltersAsync();
        StateHasChanged();
    }

    private async Task GuardarProyecto()
    {
        await AplicarFiltros();
        await JSRuntime.InvokeVoidAsync("alert", "¬°Proyecto guardado correctamente!");
    }

    private async Task DescargarImagen()
    {
        if (viewModel.CurrentProject != null)
        {
            try
            {
                var filters = new
                {
                    brightness = viewModel.EditorState.Brightness,
                    contrast = viewModel.EditorState.Contrast,
                    saturation = viewModel.EditorState.Saturation
                };

                var transformations = new
                {
                    rotation = viewModel.EditorState.Rotation,
                    flipHorizontal = viewModel.EditorState.FlipHorizontal,
                    flipVertical = viewModel.EditorState.FlipVertical,
                    perspective = viewModel.EditorState.Perspective,          
                    perspectiveVertical = viewModel.EditorState.PerspectiveVertical
                };

                await JSRuntime.InvokeVoidAsync(
                    "downloadEditedImage",
                    viewModel.CurrentProject.ImagePath,
                    viewModel.EditorState.Stickers,
                    viewModel.EditorState.TextElements,
                    filters,
                    transformations,
                    $"{viewModel.CurrentProject.Name}-editado.png"
                );
            }
            catch (Exception ex)
            {
                await JSRuntime.InvokeVoidAsync(
                    "downloadImage",
                    viewModel.CurrentProject.ImagePath,
                    $"{viewModel.CurrentProject.Name}.png"
                );
            }
        }
    }

    private async Task RotarIzquierda()
    {
        viewModel.SetRotation((viewModel.EditorState.Rotation - 90) % 360);
        await AplicarFiltros();
    }

    private async Task RotarDerecha()
    {
        viewModel.SetRotation((viewModel.EditorState.Rotation + 90) % 360);
        await AplicarFiltros();
    }

    private async Task Rotar180()
    {
        viewModel.SetRotation((viewModel.EditorState.Rotation + 180) % 360);
        await AplicarFiltros();
    }

    private async Task ToggleFlipHorizontal()
    {
        viewModel.ToggleFlipHorizontal();
        await AplicarFiltros();
    }

    private async Task ToggleFlipVertical()
    {
        viewModel.ToggleFlipVertical();
        await AplicarFiltros();
    }

    private async Task AplicarFiltroPredeterminado(string filtro)
    {
        viewModel.ApplyPresetFilter(filtro);
        await AplicarFiltros();
    }

    // ========== M√âTODOS DE ZOOM ==========
    private void ZoomIn()
    {
        zoomLevel = Math.Min(zoomLevel + 0.25, 4.0);
        StateHasChanged();
    }

    private void ZoomOut()
    {
        zoomLevel = Math.Max(zoomLevel - 0.25, 0.25);
        StateHasChanged();
    }

    private void ResetZoom()
    {
        zoomLevel = 1.0;
        StateHasChanged();
    }

    private void VolverAProyectos()
    {
        Navigation.NavigateTo("/");
    }

    // ========== M√âTODOS DE STICKERS ==========
    private void AgregarSticker(string emoji)
    {
        var nuevoSticker = new StickerElement
        {
            Content = emoji,
            X = 100,
            Y = 100,
            ScaleX = 1.0,  
            ScaleY = 1.0,  
            Rotation = 0
        };

        viewModel.EditorState.Stickers.Add(nuevoSticker);
        StateHasChanged();
    }

    private void EliminarSticker(StickerElement sticker)
    {
        viewModel.EditorState.Stickers.Remove(sticker);
        StateHasChanged();
    }

    private void EliminarTodosStickers()
    {
        viewModel.EditorState.Stickers.Clear();
        StateHasChanged();
    }

    // ========== M√âTODOS DE TEXTO ==========
    private void AgregarTexto()
    {
        if (!string.IsNullOrEmpty(nuevoTexto))
        {
            var nuevoElementoTexto = new TextElement
            {
                Text = nuevoTexto,
                Color = colorTexto,
                FontSize = tamanoTexto,
                IsBold = textoNegrita,
                IsItalic = textoItalica,
                X = 50,
                Y = 50,
                ScaleX = 1.0, 
                ScaleY = 1.0, 
                Rotation = 0
            };

            viewModel.EditorState.TextElements.Add(nuevoElementoTexto);
            nuevoTexto = "";
            StateHasChanged();
        }
    }

    private void EliminarTexto(TextElement texto)
    {
        viewModel.EditorState.TextElements.Remove(texto);
        StateHasChanged();
    }

    private void EliminarTodosTextos()
    {
        viewModel.EditorState.TextElements.Clear();
        StateHasChanged();
    }

    // ========== M√âTODOS DE ARRASTRE ==========
    private void StartDragging(object element, MouseEventArgs e)
    {
        isDragging = true;
        draggedElement = element;
        dragStartX = e.ClientX;
        dragStartY = e.ClientY;

        if (element is StickerElement sticker)
        {
            elementStartX = sticker.X;
            elementStartY = sticker.Y;
        }
        else if (element is TextElement text)
        {
            elementStartX = text.X;
            elementStartY = text.Y;
        }
    }

    // ========== M√âTODOS DE REDIMENSIONAMIENTO ==========
    private void StartResizing(object element, MouseEventArgs e)
    {
        isResizing = true;
        resizedElement = element;
        resizeStartX = e.ClientX;
        resizeStartY = e.ClientY;

        if (element is StickerElement sticker)
        {
            elementStartScale = sticker.ScaleX; 
        }
        else if (element is TextElement text)
        {
            elementStartScale = text.ScaleX; 
        }
    }

    private void StartResizingWidth(object element, MouseEventArgs e)
    {
        isResizingWidth = true;
        resizedElement = element;
        resizeStartX = e.ClientX;

        if (element is StickerElement sticker)
        {
            elementStartScaleX = sticker.ScaleX;
        }
        else if (element is TextElement text)
        {
            elementStartScaleX = text.ScaleX;
        }
    }

    private void StartResizingHeight(object element, MouseEventArgs e)
    {
        isResizingHeight = true;
        resizedElement = element;
        resizeStartY = e.ClientY;

        if (element is StickerElement sticker)
        {
            elementStartScaleY = sticker.ScaleY;
        }
        else if (element is TextElement text)
        {
            elementStartScaleY = text.ScaleY;
        }
    }

    private void StartResizingBoth(object element, MouseEventArgs e)
    {
        isResizingBoth = true;
        resizedElement = element;
        resizeStartX = e.ClientX;
        resizeStartY = e.ClientY;

        if (element is StickerElement sticker)
        {
            elementStartScaleX = sticker.ScaleX;
            elementStartScaleY = sticker.ScaleY;
        }
        else if (element is TextElement text)
        {
            elementStartScaleX = text.ScaleX;
            elementStartScaleY = text.ScaleY;
        }
    }

    private void HandleMouseMove(MouseEventArgs e)
    {
        if (isCropDragging && viewModel.EditorState.IsCropping)
        {
            var deltaX = e.ClientX - cropStartX;
            var deltaY = e.ClientY - cropStartY;
            var cropArea = viewModel.EditorState.CropArea;

            switch (cropArea.DragHandle)
            {
                case "move":
                    cropArea.X = Math.Max(0, cropAreaStartX + deltaX);
                    cropArea.Y = Math.Max(0, cropAreaStartY + deltaY);
                    break;

                case "top":
                    cropArea.Y = Math.Max(0, cropAreaStartY + deltaY);
                    cropArea.Height = Math.Max(10, cropAreaStartHeight - deltaY);
                    break;

                case "bottom":
                    cropArea.Height = Math.Max(10, cropAreaStartHeight + deltaY);
                    break;

                case "left":
                    cropArea.X = Math.Max(0, cropAreaStartX + deltaX);
                    cropArea.Width = Math.Max(10, cropAreaStartWidth - deltaX);
                    break;

                case "right":
                    cropArea.Width = Math.Max(10, cropAreaStartWidth + deltaX);
                    break;

                case "top-left":
                    cropArea.X = Math.Max(0, cropAreaStartX + deltaX);
                    cropArea.Y = Math.Max(0, cropAreaStartY + deltaY);
                    cropArea.Width = Math.Max(10, cropAreaStartWidth - deltaX);
                    cropArea.Height = Math.Max(10, cropAreaStartHeight - deltaY);
                    break;

                case "top-right":
                    cropArea.Y = Math.Max(0, cropAreaStartY + deltaY);
                    cropArea.Width = Math.Max(10, cropAreaStartWidth + deltaX);
                    cropArea.Height = Math.Max(10, cropAreaStartHeight - deltaY);
                    break;

                case "bottom-left":
                    cropArea.X = Math.Max(0, cropAreaStartX + deltaX);
                    cropArea.Width = Math.Max(10, cropAreaStartWidth - deltaX);
                    cropArea.Height = Math.Max(10, cropAreaStartHeight + deltaY);
                    break;

                case "bottom-right":
                    cropArea.Width = Math.Max(10, cropAreaStartWidth + deltaX);
                    cropArea.Height = Math.Max(10, cropAreaStartHeight + deltaY);
                    break;
            }

            ValidarLimitesRecorte();
            StateHasChanged();
        }
        else if (isResizingWidth && resizedElement != null)
        {
            var deltaX = e.ClientX - resizeStartX;
            var scaleDeltaX = deltaX / 50;
            var newScaleX = Math.Max(0.1, elementStartScaleX + scaleDeltaX);

            if (resizedElement is StickerElement sticker)
            {
                sticker.ScaleX = Math.Min(newScaleX, 5.0);
            }
            else if (resizedElement is TextElement text)
            {
                text.ScaleX = Math.Min(newScaleX, 5.0);
            }

            StateHasChanged();
        }
        else if (isResizingHeight && resizedElement != null)
        {
            var deltaY = e.ClientY - resizeStartY;
            var scaleDeltaY = deltaY / 50;
            var newScaleY = Math.Max(0.1, elementStartScaleY + scaleDeltaY);

            if (resizedElement is StickerElement sticker)
            {
                sticker.ScaleY = Math.Min(newScaleY, 5.0);
            }
            else if (resizedElement is TextElement text)
            {
                text.ScaleY = Math.Min(newScaleY, 5.0);
            }

            StateHasChanged();
        }
        else if (isResizingBoth && resizedElement != null)
        {
            var deltaX = e.ClientX - resizeStartX;
            var deltaY = e.ClientY - resizeStartY;
            var scaleDeltaX = deltaX / 50;
            var scaleDeltaY = deltaY / 50;

            var newScaleX = Math.Max(0.1, elementStartScaleX + scaleDeltaX);
            var newScaleY = Math.Max(0.1, elementStartScaleY + scaleDeltaY);

            if (resizedElement is StickerElement sticker)
            {
                sticker.ScaleX = Math.Min(newScaleX, 5.0);
                sticker.ScaleY = Math.Min(newScaleY, 5.0);
            }
            else if (resizedElement is TextElement text)
            {
                text.ScaleX = Math.Min(newScaleX, 5.0);
                text.ScaleY = Math.Min(newScaleY, 5.0);
            }

            StateHasChanged();
        }
        else if (isResizing && resizedElement != null)
        {
            var deltaX = e.ClientX - resizeStartX;
            var deltaY = e.ClientY - resizeStartY;
            var scaleDelta = (Math.Abs(deltaX) + Math.Abs(deltaY)) / 100;
            var newScale = Math.Max(0.1, elementStartScale + scaleDelta);

            if (resizedElement is StickerElement sticker)
            {
                sticker.ScaleX = Math.Min(newScale, 5.0);
                sticker.ScaleY = Math.Min(newScale, 5.0);
            }
            else if (resizedElement is TextElement text)
            {
                text.ScaleX = Math.Min(newScale, 5.0);
                text.ScaleY = Math.Min(newScale, 5.0);
            }

            StateHasChanged();
        }
        else if (isDragging && draggedElement != null)
        {
            var deltaX = e.ClientX - dragStartX;
            var deltaY = e.ClientY - dragStartY;

            if (draggedElement is StickerElement sticker)
            {
                sticker.X = elementStartX + deltaX;
                sticker.Y = elementStartY + deltaY;
            }
            else if (draggedElement is TextElement text)
            {
                text.X = elementStartX + deltaX;
                text.Y = elementStartY + deltaY;
            }

            StateHasChanged();
        }
    }

    private void HandleMouseUp(MouseEventArgs e)
    {
        isDragging = false;
        draggedElement = null;

        isResizing = false;
        isResizingWidth = false;
        isResizingHeight = false;
        isResizingBoth = false;
        resizedElement = null;

        isCropDragging = false;
        if (viewModel.EditorState.IsCropping)
        {
            viewModel.EditorState.CropArea.DragHandle = string.Empty;
        }
    }

    // ========== M√âTODOS DE RECORTE ==========
    private void ToggleCropping()
    {
        viewModel.EditorState.IsCropping = !viewModel.EditorState.IsCropping;

        if (viewModel.EditorState.IsCropping)
        {
            viewModel.EditorState.CropArea = new CropArea
            {
                X = 100,
                Y = 100,
                Width = 300,
                Height = 300
            };
        }

        StateHasChanged();
    }

    private void StartCropDragging(string handle, MouseEventArgs e)
    {
        if (!viewModel.EditorState.IsCropping) return;

        isCropDragging = true;
        viewModel.EditorState.CropArea.DragHandle = handle;
        cropStartX = e.ClientX;
        cropStartY = e.ClientY;

        cropAreaStartX = viewModel.EditorState.CropArea.X;
        cropAreaStartY = viewModel.EditorState.CropArea.Y;
        cropAreaStartWidth = viewModel.EditorState.CropArea.Width;
        cropAreaStartHeight = viewModel.EditorState.CropArea.Height;
    }

    private async Task AplicarRecorte()
    {
        if (viewModel.CurrentProject != null && viewModel.EditorState.IsCropping)
        {
            try
            {
                if (viewModel.EditorState.CropArea.Width <= 0 || viewModel.EditorState.CropArea.Height <= 0)
                {
                    await JSRuntime.InvokeVoidAsync("alert", "El √°rea de recorte no es v√°lida");
                    return;
                }

                var croppedImageUrl = await JSRuntime.InvokeAsync<string>(
                    "applyCrop",
                    viewModel.CurrentProject.ImagePath,
                    new
                    {
                        x = viewModel.EditorState.CropArea.X,
                        y = viewModel.EditorState.CropArea.Y,
                        width = viewModel.EditorState.CropArea.Width,
                        height = viewModel.EditorState.CropArea.Height
                    }
                );

                if (!string.IsNullOrEmpty(croppedImageUrl))
                {
                    viewModel.CurrentProject.ImagePath = croppedImageUrl;
                    viewModel.EditorState.IsCropping = false;

                    await JSRuntime.InvokeVoidAsync("alert", "Recorte aplicado correctamente");
                    StateHasChanged();
                }
                else
                {
                    await JSRuntime.InvokeVoidAsync("alert", "Error: No se pudo generar la imagen recortada");
                }
            }
            catch (Exception ex)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Error al aplicar el recorte: " + ex.Message);
            }
        }
    }

    private void ValidarLimitesRecorte()
    {
        var cropArea = viewModel.EditorState.CropArea;

        if (cropArea.X < 0) cropArea.X = 0;
        if (cropArea.Y < 0) cropArea.Y = 0;

        if (cropArea.Width < 10) cropArea.Width = 10;
        if (cropArea.Height < 10) cropArea.Height = 10;
    }

    private void CancelarRecorte()
    {
        viewModel.EditorState.IsCropping = false;
        StateHasChanged();
    }

    private void ActualizarRecorte()
    {
        StateHasChanged();
    }

    // ========== M√âTODOS DE PERSPECTIVA ==========
    private async Task ResetPerspective()
    {
        viewModel.EditorState.Perspective = 0;
        viewModel.EditorState.PerspectiveVertical = 0;
        await AplicarFiltros();
        StateHasChanged();
    }

    // ========== M√âTODOS DE CONVERSI√ìN DE STICKERS ==========

    private async Task ConvertirAStickerWhatsApp()
    {
        if (viewModel.CurrentProject != null)
        {
            try
            {
                // Mostrar mensaje de procesamiento
                await JSRuntime.InvokeVoidAsync("alert", "Procesando imagen para WhatsApp...");

                var filters = new
                {
                    brightness = viewModel.EditorState.Brightness,
                    contrast = viewModel.EditorState.Contrast,
                    saturation = viewModel.EditorState.Saturation
                };

                var transformations = new
                {
                    rotation = viewModel.EditorState.Rotation,
                    flipHorizontal = viewModel.EditorState.FlipHorizontal,
                    flipVertical = viewModel.EditorState.FlipVertical,
                    perspective = viewModel.EditorState.Perspective,
                    perspectiveVertical = viewModel.EditorState.PerspectiveVertical
                };

                // Llamar a la funci√≥n JavaScript para crear el sticker
                await JSRuntime.InvokeVoidAsync(
                    "convertToWhatsAppSticker",
                    viewModel.CurrentProject.ImagePath,
                    viewModel.EditorState.Stickers,
                    viewModel.EditorState.TextElements,
                    filters,
                    transformations,
                    $"{viewModel.CurrentProject.Name}-sticker.webp"
                );

            }
            catch (Exception ex)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Error al crear el sticker: " + ex.Message);
            }
        }
        else
        {
            await JSRuntime.InvokeVoidAsync("alert", "No hay imagen para convertir");
        }
    }
}

